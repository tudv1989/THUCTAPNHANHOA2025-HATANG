Khi má»™t OSD bá»‹ down, Ceph sáº½ khÃ´ng ngay láº­p tá»©c thá»±c hiá»‡n rebalance (tÃ¡i phÃ¢n phá»‘i dá»¯ liá»‡u) mÃ  sáº½ chá» má»™t khoáº£ng thá»i gian Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem OSD Ä‘Ã³ cÃ³ thá»±c sá»± máº¥t hay khÃ´ng.

CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»¥ thá»ƒ nhÆ° sau:

## OSD bá»‹ down

  + Khi má»™t OSD máº¥t káº¿t ná»‘i hoáº·c ngá»«ng hoáº¡t Ä‘á»™ng, Ceph sáº½ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  ``down`` vÃ  ``out`` sau má»™t khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh náº¿u nÃ³ khÃ´ng tá»± khÃ´i phá»¥c.

Tráº¡ng thÃ¡i nÃ y sáº½ Ä‘Æ°á»£c pháº£n Ã¡nh trong ``ceph health detail`` vÃ  cÃ¡c ``PG`` sá»­ dá»¥ng ``OSD`` Ä‘Ã³ cÃ³ thá»ƒ chuyá»ƒn sang tráº¡ng thÃ¡i ``undersized``, ``degraded``.

  + Thá»i gian chá» Ä‘á»ƒ xÃ¡c nháº­n máº¥t dá»¯ liá»‡u

Ceph cÃ³ tham sá»‘ ``mon_osd_report_timeout`` (máº·c Ä‘á»‹nh 900 giÃ¢y = 15 phÃºt), trong thá»i gian nÃ y náº¿u OSD hoáº¡t Ä‘á»™ng trá»Ÿ láº¡i thÃ¬ há»‡ thá»‘ng khÃ´ng thá»±c hiá»‡n ``rebalance``.

Náº¿u OSD khÃ´ng quay láº¡i, Ceph thá»±c hiá»‡n ``backfill & recovery``

Náº¿u sau ``mon_osd_report_timeout``, OSD váº«n khÃ´ng quay láº¡i, Ceph sáº½ báº¯t Ä‘áº§u sao chÃ©p láº¡i dá»¯ liá»‡u bá»‹ thiáº¿u tá»« cÃ¡c OSD cÃ²n sá»‘ng sang cÃ¡c OSD khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o má»©c replica Ä‘Æ°á»£c duy trÃ¬.

QuÃ¡ trÃ¬nh nÃ y gá»i lÃ  ``backfill & recovery``, lÃ m tÄƒng táº£i IO trÃªn cluster.

## Khi OSD bá»‹ máº¥t hoÃ n toÃ n (out)

Náº¿u OSD máº¥t hoÃ n toÃ n vÃ  admin chá»§ Ä‘á»™ng remove OSD khá»i cluster báº±ng lá»‡nh: ``ceph osd out <osd_id> `` `` ceph osd crush remove osd.<osd_id> `` â†’ LÃºc nÃ y Ceph sáº½ ``rebalanc``e láº¡i dá»¯ liá»‡u ngay láº­p tá»©c Ä‘á»ƒ Ä‘áº£m báº£o sá»‘ lÆ°á»£ng báº£n sao Ä‘Ãºng theo ``replication size``.

    ceph config get mon mon_osd_report_timeout

  <img src="proxmox-ceph-nexus-images/Screenshot_12.png">


CÃ¢u há»i Ä‘áº·t ra lÃ  há»‡ thá»‘ng cÃ³ tá»± remove OSD ra khá»i Cluster khi vÆ°á»£t quÃ¡ thá»i gian cá»§a ``mon_osd_report_timeout`` hay khÃ´ng?

Khi má»™t OSD bá»‹ down vÃ  vÆ°á»£t quÃ¡ thá»i gian ``mon_osd_report_timeout``, nÃ³ khÃ´ng tá»± Ä‘á»™ng bá»‹ remove khá»i cluster mÃ  sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  out sau má»™t thá»i gian nháº¥t Ä‘á»‹nh. Cá»¥ thá»ƒ:

ğŸ”¹ CÃ¡ch Ceph xá»­ lÃ½ OSD down lÃ¢u

## OSD bá»‹ down

Khi OSD máº¥t káº¿t ná»‘i, Ceph sáº½ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  down.

  + Há»‡ thá»‘ng váº«n giá»¯ metadata cá»§a OSD Ä‘Ã³, khÃ´ng loáº¡i bá» ngay.
  + Sau mon_osd_report_timeout (máº·c Ä‘á»‹nh: 900 giÃ¢y = 15 phÃºt)
  + Monitor sáº½ coi OSD lÃ  khÃ´ng pháº£n há»“i trong thá»i gian dÃ i.
  + CÃ¡c PG chá»©a OSD nÃ y cÃ³ thá»ƒ rÆ¡i vÃ o tráº¡ng thÃ¡i undersized, degraded, hoáº·c inconsistent.
  + Sau osd_out_timeout (máº·c Ä‘á»‹nh: 600 giÃ¢y = 10 phÃºt)
  + Náº¿u OSD váº«n chÆ°a quay láº¡i, nÃ³ sáº½ bá»‹ Ä‘Ã¡nh dáº¥u lÃ  â€œoutâ€.
  + Há»‡ thá»‘ng báº¯t Ä‘áº§u rebalance dá»¯ liá»‡u sang cÃ¡c OSD khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»§ sá»‘ báº£n sao (replicas).

OSD váº«n khÃ´ng quay láº¡i?

  + NÃ³ váº«n tá»“n táº¡i trong cluster, nhÆ°ng sáº½ khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u.
  + Náº¿u muá»‘n loáº¡i bá» háº³n, báº¡n pháº£i xÃ³a thá»§ cÃ´ng báº±ng: ceph osd purge <osd_id> --yes-i-really-mean-it

KÃªt luáº­n

  + mon_osd_report_timeout khÃ´ng tá»± Ä‘á»™ng xÃ³a OSD, chá»‰ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  down.
  + osd_out_timeout sáº½ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  out náº¿u máº¥t káº¿t ná»‘i quÃ¡ lÃ¢u.
  + Ceph sáº½ tá»± Ä‘á»™ng rebalance dá»¯ liá»‡u náº¿u má»™t OSD bá»‹ out.
  + Náº¿u OSD bá»‹ há»ng hoÃ n toÃ n, báº¡n pháº£i xÃ³a thá»§ cÃ´ng.
DÆ°á»›i Ä‘Ã¢y lÃ  hÆ°á»›ng dáº«n tá»«ng bÆ°á»›c Ä‘á»ƒ remove OSD.6 vÃ  add OSD.7 vÃ o cá»¥m Ceph:

---

## Remove OSD.6 khá»i cá»¥m Ceph

#### 1. Kiá»ƒm tra tráº¡ng thÃ¡i cluster
  
   ceph -s
   ceph osd tree
   
#### 2. ÄÃ¡nh dáº¥u OSD.6 lÃ  "out" (ngá»«ng phÃ¢n phá»‘i dá»¯ liá»‡u)
  
   ceph osd out osd.6
   
#### 3. Dá»«ng dá»‹ch vá»¥ OSD.6
  
   sudo systemctl stop ceph-osd@6
   
#### 4. XÃ³a OSD.6 khá»i CRUSH map
  
   ceph osd crush remove osd.6
   
#### 5. XÃ³a auth key cá»§a OSD.6
  
   ceph auth del osd.6
   
#### 6. XÃ³a OSD.6 khá»i cluster
  
   ceph osd rm osd.6
   
#### 7. Kiá»ƒm tra láº¡i cluster
  
   ceph -s
   ceph osd tree  # Äáº£m báº£o osd.6 Ä‘Ã£ biáº¿n máº¥t
   
---

## ThÃªm OSD.7 vÃ o cá»¥m Ceph

``Bash

for NODE in   cephnode13x
do
    ssh $NODE \
    "chown ceph. /etc/ceph/ceph.* /var/lib/ceph/bootstrap-osd/*; \
    parted --script /dev/sdx 'mklabel gpt'; \
    parted --script /dev/sdx "mkpart primary 0% 100%"; \
    ceph-volume lvm create --data /dev/sdx1"
done 

``
Kiá»ƒm tra OSD má»›i
  
   ceph osd tree  # XÃ¡c nháº­n osd.7 Ä‘Ã£ xuáº¥t hiá»‡n
   ceph -s        # Äáº£m báº£o cluster á»Ÿ tráº¡ng thÃ¡i HEALTH_OK
   
Tá»± Ä‘á»™ng cÃ¢n báº±ng dá»¯ liá»‡u

   - Ceph sáº½ tá»± Ä‘á»™ng replicate dá»¯ liá»‡u sang OSD.7. Theo dÃµi tiáº¿n trÃ¬nh:
  
   ceph -w
   
---

## LÆ°u Ã½ quan trá»ng

  + Dung lÆ°á»£ng clusterer: 

  + Äáº£m báº£o cluster cÃ³ Ä‘á»§ dung lÆ°á»£ng trÆ°á»›c khi remove OSD Rebalancingng

  + QuÃ¡ trÃ¬nh di chuyá»ƒn dá»¯ liá»‡u cÃ³ thá»ƒ gÃ¢y táº£i cao. 

  + Thá»±c hiá»‡n vÃ o giá» tháº¥p Ä‘iá»ƒm

  + XÃ¡c nháº­n OSD hostst 

Kiá»ƒm tra OSD.7 Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n Ä‘Ãºng host trong CRUSH map:
 
  ceph osd find osd.7
  









