### Phân tích đường đi gói tin trong KVM với 3 chế độ card mạng: NAT, Bridge, Host-Only  

#### 1. Tổng quan các chế độ mạng trong KVM
| Chế độ  | Kết nối ra Internet | Giao tiếp với Host | Giao tiếp với LAN | DHCP Server          | Switch ảo      |
|------------|-----------------------|----------------------|----------------------|-------------------------|-------------------|
| NAT    | Có (qua host)         | Có                   | Không                | dnsmasq (mặc định)    | virbr0          |
| Bridge | Có (trực tiếp)        | Có                   | Có                   | DHCP vật lý/router      | br0 (tạo thủ công) |
| Host-Only | Không               | Có                   | Không                | dnsmasq (tùy chọn)    | virbr1          |

---

## 1. Chế độ NAT (Mặc định)

### Đường đi gói tin

    VM (eth0) → virbr0 (switch ảo) → NAT (iptables/nftables) → eth0 (host) → Internet

#### Các điểm đi qua (Network Points):

1. **VM** (với card mạng eth0).  
2. **Switch ảo virbr0** (do Libvirt tạo tự động).  
3. **NAT Enginene** (sử dụng iptables/nftables trên host). 
4. **Card mạng vật lý eth0** (hoặc ens3, enp0s3 tùy host)
5. **Internet**. 


**Layout**

  <img src="kvm_checklist_images/Screenshot_1.png">

#### **Chi tiết khi sử dụng NAT**

  + DHCP Server: dnsmasq (chạy trên host, cấp IP cho VM từ dải 192.168.122.0/24).  

  + NAT Rules:  
 
    iptables -t nat -L -v  # Xem rules NAT
  
  - Gói tin từ VM ra internet được SNAT (đổi IP VM → IP host).  
  - Gói tin từ Intenet vào VM cần Port Forwarding (nếu muốn).  

#### **Nếu không tạo bridge (virbr0), VM có ra Internet không?**

❌ **Không**, vì:

- virbr0 là **switch ảo** kết nối VM với NAT engine.  
- Nếu không có virbr0, VM không có DHCP Server.  
- **DHCP Server** (dnsmasq) cũng chạy trên virbr0, nếu không có nó, VM không  Chế độ Bridge

## 2. Chế độ Bridge

**Đường đi gói tin**

    VM (eth0) → br0 (bridge) → eth0 (host) → Switch vật lý → Internet

**Các điểm đi qua**:

1. **VM** ( với card mạng eth0 )  
2. **Bridge br0** (gắn với card mạng vật lý eth0).  
3. **Card mạng vật lý eth0** (trên host).  
4. **Switch/Layout lý** → Internet.  

#### **Layout**

  <img src="kvm_checklist_images/Screenshot_2.png">

#### **Đặc điểm**
- VM nhận IP Không qua NAT(router/máy chủ DHCP).  
- Không qua NAT-Switch ảo br0c (nếu mạng cho phép).  
- Switch ảo br0 kết nối trực tiếp với card vật lý (eth0).  

#### **Nếu không tạo bridge (br0), VM có ra Internet được không?**

❌ **Không**, vì:

- VM cần bridge để kết nối với card mạng vật lý.  
- Nếu không có bridge, VM bị **cô lập** (chỉ giao tiếp nội bộ host).  

---
## 3. Chế độ Host-Only

### Đường đi gói tin

    VM (eth0) → virbr1 (switch ảo) → Host (vnetX)

#### Các điểm đi qua:

1. **VM** (với card mạng eth0).  

2. **Switch ảo virbr1** (do Libvirt tạo).  

3. **Hostst** (thông qua interface vnetX).  

**Layout**

  <img src="kvm_checklist_images/Screenshot_3.png">

**Đặc điểm**

  + Không ra Internetet, chỉ giao tiếp với host và các VM cùng mạng. 

  + DHCP Serverer: Có thể dùng dnsmasq (tùy cấu hình). 

  + Ứng dụng: Lab nội bộ, testing.  

---
## ④ Mối quan hệ giữa Switch ảo và Card mạng thật

*Yếu tố**     Switch ảo (virbr0, br0)**     Card mạng thật (eth0)0)**       |
|------------------|----------------------------------|--------------------------------Vai trò**      | Kết nối các VM với nhau hoặc host | Kết nối host với mạng vật lý   Loạiại**         | Linux bridge (brctl show)       | Phần cứng (NIC)                DHCPCP**         | Có thể chạy DHCP (dnsmasq)        | Không cung cấp DHCP            Ảnh hưởngng**    | VM phụ thuộc vào switch ảo để ra mạng | Nếu card thật hỏng → Mất kết nối |

Kết luận

*NAT**: VM ra Internet qua NAT engine (iptables), phù hợp cho máy ảo cá nhân. 

Bridgege**: VM kết nối trực tiếp với mạng vật lý, phù hợp cho server. 

Host-Onlyly**: Chỉ giao tiếp nội bộ, dùng cho lab/testing. 

Switch ảo** (virbr0, br0) là thành pbắt buộc để VM kết nối mạng. 

Card mạng thật** (eth0) là cổng ra Internet cuối cùng.  

>Kiểm tra cấu hình mạng KVM**:  

    virsh net-list --all           # Liệt kê các mạng ảo
    brctl show                    # Xem bridge
    ip a                          # Kiểm tra interface
