### Công nghệ Storage trong KVM  

KVM (Kernel-based Virtual Machine) hỗ trợ nhiều công nghệ storage linh hoạt, giúp quản lý hiệu quả dữ liệu máy ảo (VM), đảm bảo hiệu suất và khả năng mở rộng. Dưới đây là các khía cạnh chính:

---

#### 1. Định dạng Disk Ảo  

KVM sử dụng các định dạng disk ảo phổ biến: 
 
- RAW:  

  - Ưu điểm: Hiệu suất cao, tương thích với mọi hệ thống.  
  - Nhược điểm: Không hỗ trợ snapshot, chiếm toàn bộ dung lượng ngay khi tạo (thick provisioning).  
  - Ứng dụng: Phù hợp cho môi trường cần hiệu suất tối đa (VD: database).  

- QCOW2 (QEMU Copy-On-Write):  

  - Ưu điểm: Hỗ trợ snapshot, nén dữ liệu, thin provisioning (chỉ chiếm dung lượng thực dùng).  
  - Nhược điểm: Hiệu suất thấp hơn RAW do overhead.  
  - Ứng dụng: VM linh hoạt, phát triển phần mềm, cloud computing.  

- VMDK/VHDX: Định dạng tương thích với VMware/Hyper-V.  

#### 2. Quản lý Storage với LVM (Logical Volume Manager)  

- Tích hợp LVM:  
  - Tạo logical volume (LV) làm disk ảo cho VM, dễ dàng thay đổi kích thước, snapshot.  
  - Ví dụ:  
   
    lvcreate -L 20G -n lv-ubuntu VolGroup01  # Tạo LV 20GB
    virsh attach-disk ubuntu /dev/VolGroup01/lv-ubuntu vdb --persistent  # Gắn vào VM
    
 
- Ưu điểm:  
  - Linh hoạt mở rộng dung lượng, hiệu suất tốt.  
  - Hỗ trợ thin provisioning với lvcreate -V.  

---

#### 3. Các Loại Storage Backend 
 
- Local Storage:  
  - Disk ảo lưu trực tiếp trên ổ cứng vật lý của host.  
  - Ưu điểm: Hiệu suất cao, đơn giản.  
  - Nhược điểm: Khó chia sẻ giữa các host.  

- Network Storage:  
  - NFS (Network File System):  
    - Disk ảo lưu trên NAS, dễ chia sẻ giữa nhiều host.  
    - Nhược điểm: Độ trễ cao nếu mạng chậm.  
  - iSCSI:  
    - Kết nối block storage qua IP, hiệu suất tốt hơn NFS.  
  - Ceph/RBD:  
    - Hệ thống lưu trữ phân tán, hỗ trợ replication và scalability.  

---

#### 4. Storage Pool và Volume trong Libvirt  
- Storage Pool:  
  - Nguồn lưu trữ tập trung (VD: thư mục, LVM volume, iSCSI target).  
  - Tạo pool:  
   
    virsh pool-define-as --name mypool --type dir --target /mnt/storage
    virsh pool-start mypool
    
 
- Volume:  
  - Disk ảo trong pool, được VM sử dụng.  
  - Tạo volume:  
   
    virsh vol-create-as mypool ubuntu-disk 20G --format qcow2
    
---

#### 5. Thin Provisioning vs Thick Provisioning  
| Tiêu chí       | Thin Provisioning            | Thick Provisioning          |  
|--------------------|----------------------------------|---------------------------------|  
| Dung lượng     | Cấp phát động theo nhu cầu      | Cấp phát toàn bộ ngay từ đầu    |  
| Hiệu suất      | Thấp hơn do cấp phát động       | Cao hơn                        |  
| Ứng dụng       | Tiết kiệm không gian lưu trữ    | Ứng dụng cần hiệu suất ổn định |  

---

#### 6. Công cụ Quản lý  
- virsh:  
  - Tạo/xóa pool, volume, gắn disk vào VM:  
   
    virsh attach-disk ubuntu /path/to/disk.qcow2 vda --persistent
    
 
- virt-manager: Giao diện đồ họa quản lý storage.  
- qemu-img: Tạo/chuyển đổi định dạng disk:  
 
    qemu-img create -f qcow2 ubuntu.qcow2 20G  # Tạo disk QCOW2
    qemu-img convert -O raw ubuntu.qcow2 ubuntu.raw  # Chuyển sang RAW
  
---

#### 7. Best Practices  
- Chọn định dạng phù hợp:  
  - Dùng QCOW2 cho VM cần snapshot và linh hoạt.  
  - Dùng RAW cho ứng dụng I/O cao.  
- Kết hợp LVM và Network Storage:  
  - Sử dụng LVM trên Ceph/RBD để cân bằng hiệu suất và khả năng mở rộng.  
- Theo dõi dung lượng:  
  - Tránh hết dung lượng đột ngột với thin provisioning.  

---
### Ví dụ Thực Tế  

Cấu hình VM sử dụng QCOW2 trên NFS:

1. Mount NFS vào host:  
  
    mount -t nfs 192.168.1.100:/nfs-share /mnt/nfs
   
 
2. Tạo storage pool từ NFS:  
  
    virsh pool-define-as --name nfs-pool --type netfs --source-host 192.168.1.100 --source-path /nfs-share --target /mnt/nfs
    virsh pool-start nfs-pool
   
 
3. Tạo VM với disk từ pool:  

    virt