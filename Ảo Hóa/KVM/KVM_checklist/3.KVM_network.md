### Các chế độ card mạng trong KVM 
 
KVM hỗ trợ nhiều chế độ card mạng ảo (virtual network interfaces) để kết nối máy ảo (VM) với mạng vật lý hoặc mạng ảo nội bộ. Dưới đây là các chế độ phổ biến và đặc điểm của từng loại:  

---

## 1. Chế độ NAT (Network Address Translation) 
 
- Đặc điểm:  
  - VM sử dụng địa chỉ IP từ một dải riêng do KVM cung cấp (thường 192.168.122.0/24).  
  - KVM host đóng vai trò gateway NAT, giúp VM ra Internet nhưng ẩn IP thật.  
  - Máy ngoài mạng không thể kết nối trực tiếp vào VM (trừ khi cấu hình port forwarding).  
- Ưu điểm:  
  - An toàn, phù hợp cho các VM không cần public IP.  
  - Dễ triển khai, không cần cấu hình phức tạp.  
- Nhược điểm:  
  - Không phù hợp cho server cần public IP (VD: web server).  
- Cấu hình mặc định:  
 
  virsh net-list --all  # Hiển thị mạng mặc định (thường là 'default' dùng NAT)
  
---

## 2. Chế độ Bridge (Bridge Networking)  

- Đặc điểm:  
  - VM kết nối trực tiếp vào mạng vật lý như một thiết bị độc lập.  
  - VM nhận IP từ DHCP vật lý (hoặc cấu hình tĩnh) và có thể ping được từ mạng ngoài.  
  - Phù hợp cho máy chủ cần public IP (VPS, web server).  
- Ưu điểm:  
  - Hiệu suất cao, độ trễ thấp.  
  - VM có thể giao tiếp trực tiếp với các thiết bị khác trong mạng LAN.  
- Nhược điểm:  
  - Cần cấu hình bridge trên host (phức tạp hơn NAT).  
  - VM dễ bị tấn công nếu không có firewall.  
- Cấu hình:  
 
  # Tạo bridge trên host (VD: br0)
  ip link add name br0 type bridge
  ip link set br0 up
  ip link set eth0 master br0  # Gán card vật lý vào bridge
  
---

## 3. Chế độ Host-only (Private Network)  

- Đặc điểm:  
  - Các VM kết nối với nhau và host trong một mạng ảo riêng, không ra Internet.  
  - Phù hợp cho môi trường lab, testing (VD: máy ảo database chỉ giao tiếp nội bộ).  
- Ưu điểm:  
  - Cô lập hoàn toàn với mạng bên ngoài, bảo mật cao.  
- Nhược điểm:  
  - VM không thể truy cập Internet.  
- Cấu hình:  
 
  virsh net-define /tmp/hostonly.xml  # Tạo mạng host-only
  virsh net-start hostonly
  
---

## 4. Chế độ MACVTAP/Passthrough  

- Đặc điểm:  
  - Gán trực tiếp MAC address của VM vào card mạng vật lý, bỏ qua lớp bridge.  
  - Hiệu suất cực cao, phù hợp cho ứng dụng cần băng thông lớn (VD: VoIP, streaming).  
- Ưu điểm:  
  - Giảm độ trễ, tận dụng tối đa băng thông vật lý.  
- Nhược điểm:  
  - Không hỗ trợ một số tính năng mạng ảo (VD: DHCP, firewall).  
  - Phức tạp khi triển khai.  
- Cấu hình:  
 
  <interface type='direct'>
    <source dev='eth0' mode='passthrough'/>
  </interface>
  
---

## 5. Chế độ SR-IOV (Single Root I/O Virtualization)  

- Đặc điểm:  
  - Card mạng vật lý hỗ trợ SR-IOV (Intel 82599, Mellanox) được chia thành nhiều Virtual Functions (VF).  
  - Mỗi VM nhận một VF riêng, hoạt động như card mạng vật lý độc lập.  
  - Hiệu suất gần bằng bare-metal, độ trễ cực thấp.  
- Ưu điểm:  
  - Phù hợp cho high-performance networking (VD: NFV, telecom).  
- Nhược điểm:  
  - Yêu cầu phần cứng đặc biệt.  
  - Khó debug khi gặp lỗi.  
- Cấu hình:  
 
    lspci | grep -i ethernet  # Kiểm tra card hỗ trợ SR-IOV
    echo 8 > /sys/class/net/eth0/device/sriov_numvfs  # Tạo 8 VFs
  
---

### Tóm tắt so sánh  

| Chế độ       | Kết nối ra Internet | Giao tiếp với Host | Giao tiếp với LAN | Hiệu suất | Phù hợp                |
|------------------|-----------------------|-----------------------|----------------------|--------------|---------------------------|
| NAT         | Có (qua host)         | Có                    | Không                | Trung bình   | VM cá nhân, dev           |
| Bridge      | Có (trực tiếp)        | Có                    | Có                   | Cao          | Server public (VPS, web)  |

Đinh Tú, [4/21/2025 11:06 AM]
| Host-only   | Không                 | Có                    | Không                | Thấp         | Lab nội bộ                |
| MACVTAP     | Có (tùy cấu hình)     | Không                 | Có                   | Rất cao      | Ứng dụng real-time        |
| SR-IOV      | Có (trực tiếp)        | Không                 | Có                   | Cực cao      | High-performance network  |

### Lựa chọn chế độ phù hợp  

- NAT: Dành cho VM cá nhân không cần public IP.  
- Bridge: Phù hợp cho VPS, web server cần kết nối trực tiếp ra Internet.  
- Host-only: Dùng cho mạng nội bộ (VD: database, testing).  
- MACVTAP/SR-IOV: Ứng dụng đòi hỏi hiệu suất mạng cao (VD: game server, VoIP).  

> 💡 Tip: Kiểm tra card mạng hiện có trên KVM bằng lệnh:  
>
> virsh domiflist <tên-VM>
>