## Mình sẽ trình bày diễn giải chi tiết

#### 1. Dưới đây là các bước tạo cụm KVM HA và sử dụng storage là NFS để chứa thông tin máy ảo:

#### 2.Tạo một cặp khóa SSH mới không có mật khẩu và lưu chúng vào thư mục ``/root/.ssh``.

Trên ``kvmnode137`` chạy lệnh sau: 

```Bash
rm -rf ~/.ssh/*
ssh-keygen -t rsa -b 4096 -N "" -f  /root/.ssh/id_rsa -q
```

#### 3. Tiếp theo, tạo một file cấu hình SSH mới trong ``~/.ssh/config`` với thông tin về cách kết nối đến các node trong cụm Ceph.

```Bash
cat > ~/.ssh/config << 'OEF'
Host kvmnode137
    Hostname kvmnode137.dinhtu.xyz 
    User root
Host kvmnode138
    Hostname kvmnode138.dinhtu.xyz 
    User root
Host kvmnode139
    Hostname kvmnode139.dinhtu.xyz 
    User root
OEF

```

#### 4. Phần tiếp theo tạo một file ``/etc/hosts`` mới với các địa chỉ IP và tên máy chủ cho cụm Ceph. Lưu ý đối với giao tiếp giữa các Node các bạn nên sử dụng IP Private của mỗi Node, đây là IP có băng thông cao sử dụng cho kết nối các cluster trong cụm ví dụ như dưới.

Ví dụ:

```Bash

cat >> /etc/hosts << 'OEF'
10.10.88.137 kvmnode137.dinhtu.xyz kvmnode137
10.10.88.138 kvmnode138.dinhtu.xyz kvmnode138
10.10.88.139 kvmnode139.dinhtu.xyz kvmnode139
OEF

```

#### 5. Sao chép khóa công khai SSH đến node còn lại trong cụm.

Sử dụng lệnh ``ssh-copy-id`` sao chép khóa công khai SSH đến node trong trong cụm, tính luôn cả ``kvmnode137``, ví dụ của mình là ``kvmnode138`` và ``kvmnode139``.
Ví dụ:

```Bash

ssh-copy-id -o StrictHostKeychecking=no kvmnode137
ssh-copy-id -o StrictHostKeychecking=no kvmnode138
ssh-copy-id -o StrictHostKeychecking=no kvmnode139

```

Tùy chọn ``-o StrictHostKeychecking=no`` ngăn chặn việc kiểm tra dấu vân tay của máy chủ, cho phép kết nối tự động.

Dưới đây là ví dụ đầu ra khi chạy lệnh trên ở một node bất kỳ sẽ tương tự như dưới.

Nhập mật khẩu của root Node Remote để thực hiện việc sao chép.

Chúng ta cần làm tương tự trên các node còn lại, nói chung 3 node phải sử dụng ssh key để liên lạc với nhau

#### 6. Cài đặt Pacemaker, Corosync và Pcsd  (áp dụng cho cả 3 server kvm-node01, kvm-node02 và kvm-node03)

Pacemaker, Corosync và Pcsd có sẵn trong kho lưu trữ hệ thống mặc định. Vì vậy, tất cả chúng có thể được cài đặt từ kho lưu trữ Ubuntu bằng lệnh apt như sau.


```Bash

for NODE in kvmnode137 kvmnode138 kvmnode139
do
    ssh -o StrictHostKeychecking=no $NODE "apt install corosync pacemaker pcs -y"
done 

```

Sau khi quá trình cài đặt hoàn tất, hãy cho phép tất cả các dịch vụ tự động khởi chạy khi khởi động hệ thống bằng các lệnh systemctl bên dưới.

```Bash

for NODE in kvmnode137 kvmnode138 kvmnode139
do
    ssh -o StrictHostKeychecking=no $NODE "systemctl enable pcsd"
done 

for NODE in kvmnode137 kvmnode138 kvmnode139
do
    ssh -o StrictHostKeychecking=no $NODE "systemctl enable corosync"
done 

for NODE in kvmnode137 kvmnode138 kvmnode139
do
    ssh -o StrictHostKeychecking=no $NODE "systemctl enable pacemaker"
done 

```
Hãy khởi động dịch vụ pcsd Pacemaker trên tất cả các server.

```Bash

for NODE in kvmnode137 kvmnode138 kvmnode139
do
    ssh -o StrictHostKeychecking=no $NODE "systemctl start pcsd"
done 

```

Tiếp theo, tạo một mật khẩu mới cho người dùng ``hacluster`` và sử dụng cùng một mật khẩu cho tất cả các server. Người dùng này đã được tạo tự động trong quá trình cài đặt phần mềm.

    echo 'hacluster:tudv1989' | chpasswd

#### 7. Tạo và cấu hình 1 cluster mới (chỉ chạy trên kvmnode137).

Để tạo cluster, chúng ta cần cấp quyền cho tất cả các server bằng lệnh pcs và người dùng hacluster. Cấp quyền cho tất cả các server bằng lệnh pcs, hãy sử dụng username và password của hacluster để xác nhận.

```Bash

root@kvmnode137:/var/lib/pcsd#  pcs host auth kvmnode137.dinhtu.xyz kvmnode138.dinhtu.xyz kvmnode139.dinhtu.xyz
Username: hacluster
Password: tudv1989
kvmnode137.dinhtu.xyz: Authorized
kvmnode138.dinhtu.xyz: Authorized
kvmnode139.dinhtu.xyz: Authorized

pcs cluster setup ha_cluster kvmnode137.dinhtu.xyz kvmnode138.dinhtu.xyz kvmnode139.dinhtu.xyz --force

pcs cluster start --all

pcs cluster enable --all

pcs status cluster

pcs status corosync

pcs property set stonith-enabled=false

pcs property config

```

#### 8. Cài đặt NFS server và chia sẻ ``/data`` đến cả 3 node KVM

```Bash

root@tudv:~# exportfs -v
/data           <world>(sync,wdelay,hide,no_subtree_check,fsid=1,sec=sys,rw,secure,no_root_squash,no_all_squash)

```
#### 9. Tạo ``/data`` trên cả 3 node KVM

```Bash

root@kvmnode137:/var/lib/libvirt/images# cat /etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation
/dev/disk/by-id/dm-uuid-LVM-XSlh5zIJ3OGfmUuDUJVYEF1b0PNbjbyxeTOHXj3v0BdZ3StRRaVR4AxfOuvRt0JN / ext4 defaults 0 1
# /boot was on /dev/sda2 during curtin installation
/dev/disk/by-uuid/b6d8d7c1-6f75-43f9-a698-9630e1f36de3 /boot ext4 defaults 0 1
/swap.img       none    swap    sw      0       0
10.10.88.141:/data /data nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0

```

#### 10. Tạo máy ảo trên 1 node KVM bằng lệnh:

    qemu-img create -b /data/images/jammy-server-ubuntu2204-cloudimg-amd64.img -F raw -f qcow2 /data/vps-test/os-vps-test.qcow2 24G

Với ``jammy-server-ubuntu2204-cloudimg-amd64.img`` mình tải trên mạng về

    wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O /data/images/jammy-server-ubuntu2204-cloudimg-amd64.img

#### 11. Test Live Migrate

    virsh migrate --live vps-test qemu+ssh://kvmnode138.dinhtu.xyz/system

    virsh migrate --live vps-test qemu+ssh://kvmnode139.dinhtu.xyz/system

