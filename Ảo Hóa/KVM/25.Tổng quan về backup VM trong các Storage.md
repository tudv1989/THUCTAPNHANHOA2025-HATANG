### **Tổng quan và Hướng dẫn Backup/Restore Máy Ảo (VM) trên Các Loại Storage: Dir, LVM, Ceph**

---

## **1. Directory-based Storage (Dir)**
### **Tổng quan**
- **Đặc điểm**:  
  - VM disk được lưu dưới dạng file image (VD: `qcow2`, `raw`) trong thư mục (ví dụ: `/var/lib/libvirt/images`).  
  - Phù hợp cho môi trường nhỏ, đơn giản.  
- **Ưu điểm**: Dễ triển khai, không cần cấu hình phức tạp.  
- **Nhược điểm**: Hiệu suất thấp hơn LVM/Ceph, không hỗ trợ snapshot native.  

---

### **Backup VM trên Dir**
#### **Phương pháp 1: Copy File Image và XML**
1. **Dừng VM** (hoặc dùng live backup nếu hỗ trợ):  
   ```bash
   sudo virsh shutdown vm1
   ```
2. **Backup file disk và XML**:  
   ```bash
   sudo cp /var/lib/libvirt/images/vm1.qcow2 /backup/
   sudo virsh dumpxml vm1 > /backup/vm1.xml
   ```
3. **Khởi động lại VM**:  
   ```bash
   sudo virsh start vm1
   ```

#### **Phương pháp 2: Dùng `rsync` (Incremental Backup)**  
   ```bash
   sudo rsync -avh --progress /var/lib/libvirt/images/vm1.qcow2 /backup/
   ```

---

### **Restore VM trên Dir**
1. **Copy file image và XML về thư mục gốc**:  
   ```bash
   sudo cp /backup/vm1.qcow2 /var/lib/libvirt/images/
   sudo virsh define /backup/vm1.xml
   ```
2. **Khởi động VM**:  
   ```bash
   sudo virsh start vm1
   ```

---

## **2. LVM Storage**
### **Tổng quan**
- **Đặc điểm**:  
  - VM disk được lưu trên logical volume (LV).  
  - Hỗ trợ snapshot, thin provisioning.  
- **Ưu điểm**: Hiệu suất cao, phù hợp cho môi trường production.  
- **Nhược điểm**: Cần quản lý volume cẩn thận.  

---

### **Backup VM trên LVM**
#### **Phương pháp 1: Snapshot LVM**
1. **Tạo snapshot**:  
   ```bash
   sudo lvcreate -s -n vm1_snap -L 10G /dev/vg0/vm1_disk
   ```
2. **Mount snapshot để backup**:  
   ```bash
   sudo mkdir /mnt/vm1_snap
   sudo mount /dev/vg0/vm1_snap /mnt/vm1_snap
   sudo rsync -avh /mnt/vm1_snap/ /backup/vm1/
   ```
3. **Xóa snapshot**:  
   ```bash
   sudo umount /mnt/vm1_snap
   sudo lvremove /dev/vg0/vm1_snap
   ```

#### **Phương pháp 2: Dùng `qemu-img convert`**  
   ```bash
   sudo qemu-img convert -f raw -O qcow2 /dev/vg0/vm1_disk /backup/vm1.qcow2
   ```

---

### **Restore VM trên LVM**
1. **Tạo LV mới và restore data**:  
   ```bash
   sudo lvcreate -n vm1_restored -L 20G vg0
   sudo qemu-img convert -O raw /backup/vm1.qcow2 /dev/vg0/vm1_restored
   ```
2. **Định nghĩa lại VM từ XML**:  
   ```bash
   sudo virsh define /backup/vm1.xml
   ```

---

## **3. Ceph Storage (RBD)**
### **Tổng quan**
- **Đặc điểm**:  
  - VM disk được lưu trên Ceph cluster dưới dạng RBD image.  
  - Hỗ trợ snapshot, clone, replication.  
- **Ưu điểm**: Khả năng mở rộng cao, phù hợp cho cloud.  
- **Nhược điểm**: Cần cấu hình phức tạp.  

---

### **Backup VM trên Ceph**
#### **Phương pháp 1: Snapshot RBD**
1. **Tạo snapshot**:  
   ```bash
   sudo rbd snap create pool/vm1_disk@snap1
   ```
2. **Export snapshot thành file**:  
   ```bash
   sudo rbd export pool/vm1_disk@snap1 /backup/vm1.raw
   ```

#### **Phương pháp 2: Incremental Backup**  
   ```bash
   sudo rbd export-diff pool/vm1_disk@snap2 --from-snap snap1 /backup/vm1_inc.raw
   ```

---

### **Restore VM trên Ceph**
1. **Import image vào Ceph**:  
   ```bash
   sudo rbd import /backup/vm1.raw pool/vm1_restored
   ```
2. **Định nghĩa lại VM từ XML**:  
   ```bash
   sudo virsh define /backup/vm1.xml
   ```

---

## **4. So Sánh Các Phương Pháp**
| Storage Type | Phương Pháp Backup          | Ưu Điểm                          | Nhược Điểm                     |
|--------------|-----------------------------|----------------------------------|--------------------------------|
| **Dir**      | Copy file image             | Đơn giản                        | Cần downtime                   |
|              | `rsync`                     | Incremental backup               | Chậm với disk lớn             |
| **LVM**      | Snapshot LVM                | Nhanh, hỗ trợ live backup       | Tốn dung lượng                |
|              | `qemu-img convert`          | Backup đầy đủ định dạng         | Phức tạp                      |
| **Ceph**     | Snapshot RBD                | Không downtime                  | Phụ thuộc vào Ceph cluster    |
|              | Incremental backup          | Tiết kiệm dung lượng            | Cần quản lý snapshot          |

---

## **5. Lời Khuyên**
- **Dir**: Dùng cho môi trường nhỏ, backup định kỳ bằng `rsync`.  
- **LVM**: Ưu tiên snapshot kết hợp `qemu-img convert` để cân bằng hiệu suất.  
- **Ceph**: Dùng RBD snapshot + incremental backup để tiết kiệm dung lượng.  
- **Luôn test restore** trước khi áp dụng vào production!  