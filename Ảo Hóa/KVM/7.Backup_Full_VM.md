#!/bin/bash

# Danh sách tên các máy ảo cần backup
VM_NAMES=$(virsh list --all --name)

# Cấu hình thư mục backup và log
BACKUP_BASE_DIR="/mnt/backups"
LOG_FILE="/var/log/kvm_backup.log"

# Hàm ghi log
log() {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] $1" >> "$LOG_FILE"
}

# Tạo thư mục backup nếu chưa tồn tại
mkdir -p "$BACKUP_BASE_DIR"

# Vòng lặp backup từng VM
for vm in $VM_NAMES; do
    TIMESTAMP=$(date +"%Y%m%d%H%M%S")
    VM_BACKUP_DIR="${BACKUP_BASE_DIR}/${vm}"
    
    # Tạo thư mục backup cho VM
    mkdir -p "$VM_BACKUP_DIR"
    
    log "Bắt đầu backup VM: $vm"
    
    # Đường dẫn file disk và config
    IMAGE_PATH="/var/lib/libvirt/images/${vm}.qcow2"
    CONFIG_PATH="/etc/libvirt/qemu/${vm}.xml"
    
    # Tạo tên file backup
    BACKUP_IMAGE="${VM_BACKUP_DIR}/${vm}_full_${TIMESTAMP}.qcow2"
    BACKUP_CONFIG="${VM_BACKUP_DIR}/${vm}_config_full_${TIMESTAMP}.xml"
    
    # Backup disk image
    log "Đang backup disk image..."
    cp -rp "$IMAGE_PATH" "$BACKUP_IMAGE"
    if [ $? -ne 0 ]; then
        log "Lỗi: Backup disk image thất bại cho $vm"
        continue
    fi
    
    # Backup file config
    log "Đang backup file cấu hình..."
    cp "$CONFIG_PATH" "$BACKUP_CONFIG"
    if [ $? -ne 0 ]; then
        log "Lỗi: Backup file cấu hình thất bại cho $vm"
        continue
    fi
    
    log "Hoàn thành backup VM $vm"
    log "Disk image: $BACKUP_IMAGE"
    log "File config: $BACKUP_CONFIG"
done

log "Đã hoàn thành backup tất cả VM"
