## Corosync

Trong Proxmox VE, Corosync đóng vai trò then chốt trong việc quản lý cluster và đảm bảo tính sẵn sàng cao (HA).

    https://pve.proxmox.com/pve-docs/chapter-pvecm.html#_adding_redundant_links_to_an_existing_cluster

```Bash
logging {
  debug: off
  to_syslog: yes
}

nodelist {
  node {
    name: proxmox111
    nodeid: 1
    quorum_votes: 1
    ring1_addr: 10.10.100.111
  }
  node {
    name: proxmox112
    nodeid: 2
    quorum_votes: 1
    ring1_addr: 10.10.100.112
  }
  node {
    name: proxmox113
    nodeid: 3
    quorum_votes: 1
    ring1_addr: 10.10.100.113
  }
}

quorum {
  provider: corosync_votequorum
}

totem {
  cluster_name: ProxCephCluster
  config_version: 3
  interface {
    linknumber: 1
  }
  ip_version: ipv4-6
  link_mode: passive
  secauth: on
  version: 2
}

```
#### 1. Logging (Ghi Log):
```Bash
logging {
  debug: off
  to_syslog: yes
}
```
  + debug: off: Tắt chế độ ghi log chi tiết (debug). Điều này giúp giảm lượng log và cải thiện hiệu suất.
  + to_syslog: yes: Gửi log Corosync đến hệ thống log của hệ điều hành (syslog). Điều này giúp quản lý log tập trung và dễ dàng theo dõi.

#### 2. Nodelist (Danh Sách Nút):
```Bash
nodelist {
  node {
    name: proxmox111
    nodeid: 1
    quorum_votes: 1
    ring1_addr: 10.10.100.111
  }
  node {
    name: proxmox112
    nodeid: 2
    quorum_votes: 1
    ring1_addr: 10.10.100.112
  }
  node {
    name: proxmox113
    nodeid: 3
    quorum_votes: 1
    ring1_addr: 10.10.100.113
  }
}
```
    Định nghĩa 3 nút (node) trong cluster: proxmox111, proxmox112, và proxmox113.
    Mỗi nút có một nodeid duy nhất (1, 2, 3).
    Mỗi nút có quorum_votes: 1, nghĩa là mỗi nút đóng góp 1 phiếu bầu vào quorum.
ring1_addr: Chỉ định địa chỉ IP mà Corosync sử dụng để giao tiếp giữa các nút. Các địa chỉ này cần phải thông suốt, và không trùng lặp.

#### 3.Quorum:
```Bash
quorum {
  provider: corosync_votequorum
}
```
Sử dụng thuật toán corosync_votequorum để quản lý quorum. Điều này dựa trên số phiếu bầu của các nút để xác định trạng thái cluster.
Với 3 node, và mỗi node có 1 vote, thì cluster cần tối thiểu 2 node online, để duy trì hoạt động.

#### 4.Totem:
```Bash
totem {
  cluster_name: ProxCephCluster
  config_version: 3
  interface {
    linknumber: 1
  }
  ip_version: ipv4-6
  link_mode: passive
  secauth: on
  version: 2
}
```
  + cluster_name: ProxCephCluster: Tên của cluster.
  + config_version: 3: Phiên bản cấu hình Totem.
  + interface { linknumber: 1 }: Chỉ định giao diện mạng cho giao tiếp Corosync.
  + ip_version: ipv4-6: Hỗ trợ cả IPv4 và IPv6.
  + link_mode: passive: Chế độ liên kết thụ động, phù hợp cho mạng không ổn định.
  + secauth: on: Kích hoạt xác thực bảo mật.
  + version: 2: Phiên bản giao thức Totem.

## Một vài khuyến nghị

#### 1. Mạng (Network):

Đảm bảo mạng giữa các nút có độ trễ thấp và ổn định. Điều này rất quan trọng cho hoạt động của Corosync và quorum.
Nếu có thể, hãy sử dụng mạng riêng biệt cho giao tiếp Corosync để tăng tính ổn định.
Kiểm tra kỹ lưỡng các địa chỉ IP ring1_addr để đảm bảo chúng chính xác và có thể kết nối được.

#### 2. Quorum:

Với 3 nút, cluster có thể chịu được lỗi của 1 nút. Tuy nhiên, hãy cân nhắc thêm nút nếu bạn cần khả năng chịu lỗi cao hơn.
Cần đặc biệt lưu ý khi có sự cố mạng, vì khi mạng chia cắt, sẽ có hiện tượng phân mảnh cluster (split brain).
Nếu có thể hãy triển khai một thiết bị Quorum(QDevice) cho Proxmox, điều này sẽ giúp ngăn chặn hiện tượng split brain.

#### 3. Bảo Mật:

secauth: on là một cấu hình tốt. Hãy đảm bảo rằng bạn quản lý khóa xác thực một cách an toàn.
Giám Sát (Monitoring):

Theo dõi log syslog của Corosync để phát hiện sớm các vấn đề.
Sử dụng các công cụ giám sát Proxmox để theo dõi trạng thái cluster và tài nguyên.

#### 4. Sao Lưu (Backup):

Thiết lập sao lưu thường xuyên cho các máy ảo và container trong cluster.
Kiểm tra định kì tính khả dụng của các bản sao lưu.

#### 5. Cập Nhật (Updates):

Luôn cập nhật Proxmox và các gói phần mềm liên quan để đảm bảo bảo mật và hiệu suất tốt nhất.

#### 6. Kiểm Tra và Thử Nghiệm (Testing):

Sau khi cấu hình, hãy kiểm tra kỹ lưỡng hoạt động của cluster, bao gồm khả năng chịu lỗi và hiệu suất.
Thực hiện các thử nghiệm failover để đảm bảo cluster hoạt động đúng như mong đợi.
Những lời khuyên này sẽ giúp bạn quản lý cluster Proxmox một cách hiệu quả và đảm bảo tính ổn định và bảo mật.