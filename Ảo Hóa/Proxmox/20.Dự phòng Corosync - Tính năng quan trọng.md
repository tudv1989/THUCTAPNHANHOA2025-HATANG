## Corosync

Trong Proxmox VE, Corosync đóng vai trò then chốt trong việc quản lý cluster và đảm bảo tính sẵn sàng cao (HA).

    https://pve.proxmox.com/pve-docs/chapter-pvecm.html#_adding_redundant_links_to_an_existing_cluster

```Bash
logging {
  debug: off
  to_syslog: yes
}

nodelist {
  node {
    name: proxmox111
    nodeid: 1
    quorum_votes: 1
    ring1_addr: 10.10.100.111
  }
  node {
    name: proxmox112
    nodeid: 2
    quorum_votes: 1
    ring1_addr: 10.10.100.112
  }
  node {
    name: proxmox113
    nodeid: 3
    quorum_votes: 1
    ring1_addr: 10.10.100.113
  }
}

quorum {
  provider: corosync_votequorum
}

totem {
  cluster_name: ProxCephCluster
  config_version: 3
  interface {
    linknumber: 1
  }
  ip_version: ipv4-6
  link_mode: passive
  secauth: on
  version: 2
}

```
#### 1. Logging (Ghi Log):
```Bash
logging {
  debug: off
  to_syslog: yes
}
```
  + debug: off: Tắt chế độ ghi log chi tiết (debug). Điều này giúp giảm lượng log và cải thiện hiệu suất.
  + to_syslog: yes: Gửi log Corosync đến hệ thống log của hệ điều hành (syslog). Điều này giúp quản lý log tập trung và dễ dàng theo dõi.

#### 2. Nodelist (Danh Sách Nút):
```Bash
nodelist {
  node {
    name: proxmox111
    nodeid: 1
    quorum_votes: 1
    ring1_addr: 10.10.100.111
  }
  node {
    name: proxmox112
    nodeid: 2
    quorum_votes: 1
    ring1_addr: 10.10.100.112
  }
  node {
    name: proxmox113
    nodeid: 3
    quorum_votes: 1
    ring1_addr: 10.10.100.113
  }
}
```
    Định nghĩa 3 nút (node) trong cluster: proxmox111, proxmox112, và proxmox113.
    Mỗi nút có một nodeid duy nhất (1, 2, 3).
    Mỗi nút có quorum_votes: 1, nghĩa là mỗi nút đóng góp 1 phiếu bầu vào quorum.
ring1_addr: Chỉ định địa chỉ IP mà Corosync sử dụng để giao tiếp giữa các nút. Các địa chỉ này cần phải thông suốt, và không trùng lặp.

#### 3.Quorum:
```Bash
quorum {
  provider: corosync_votequorum
}
```
Sử dụng thuật toán corosync_votequorum để quản lý quorum. Điều này dựa trên số phiếu bầu của các nút để xác định trạng thái cluster.
Với 3 node, và mỗi node có 1 vote, thì cluster cần tối thiểu 2 node online, để duy trì hoạt động.

#### 4.Totem:
```Bash
totem {
  cluster_name: ProxCephCluster
  config_version: 3
  interface {
    linknumber: 1
  }
  ip_version: ipv4-6
  link_mode: passive
  secauth: on
  version: 2
}
```
  + cluster_name: ProxCephCluster: Tên của cluster.
  + config_version: 3: Phiên bản cấu hình Totem.
  + interface { linknumber: 1 }: Chỉ định giao diện mạng cho giao tiếp Corosync.
  + ip_version: ipv4-6: Hỗ trợ cả IPv4 và IPv6.
  + link_mode: passive: Chế độ liên kết thụ động, phù hợp cho mạng không ổn định.
  + secauth: on: Kích hoạt xác thực bảo mật.
  + version: 2: Phiên bản giao thức Totem.

Trong Proxmox VE, Corosync đóng vai trò then chốt trong việc quản lý cluster và đảm bảo tính sẵn sàng cao (HA). Dưới đây là giải thích chi tiết về cấu hình Corosync và khái niệm quorum:
Cấu hình Corosync trong Proxmox VE:
 * Mục đích:
   * Corosync tạo ra một lớp giao tiếp đáng tin cậy giữa các nút (node) trong cluster Proxmox VE.
   * Nó cho phép các nút trao đổi thông tin về trạng thái của nhau, giúp hệ thống đưa ra quyết định thống nhất.
 * Cấu hình chính:
   * Cấu hình Corosync được lưu trữ trong tệp /etc/pve/corosync.conf.
   * Các thông số quan trọng bao gồm:
     * quorum: Cấu hình số lượng nút tối thiểu cần thiết để cluster hoạt động.
     * nodelist: Danh sách các nút trong cluster và địa chỉ IP của chúng.
     * interface: Giao diện mạng mà Corosync sử dụng để liên lạc.
   * Proxmox VE tự động quản lý phần lớn cấu hình Corosync, nhưng bạn có thể điều chỉnh một số thông số nếu cần.
 * Giao tiếp mạng:
   * Corosync sử dụng giao thức UDP để giao tiếp giữa các nút.
   * Các cổng UDP 5405-5412 cần được mở trên tường lửa của tất cả các nút.
   * Để có hiệu suất tốt nhất, nên sử dụng một giao diện mạng riêng biệt cho lưu lượng Corosync.
Quorum:
 * Định nghĩa:
   * Quorum là số lượng nút tối thiểu cần thiết trong một cluster để duy trì hoạt động.
   * Nó đảm bảo rằng chỉ khi có đủ số nút hoạt động, cluster mới đưa ra quyết định và thực hiện các thay đổi.
   * Quorum giúp ngăn chặn tình trạng "split-brain", khi hai hoặc nhiều phần của cluster hoạt động độc lập và gây ra xung đột dữ liệu.
 * Nguyên tắc hoạt động:
   * Corosync sử dụng thuật toán quorum để xác định xem cluster có đủ số nút hoạt động hay không.
   * Công thức tính quorum thường là: (số nút hoạt động) > (tổng số nút trong cluster) / 2.
   * Ví dụ:
     * Với cluster 3 nút, quorum là 2 nút.
     * Với cluster 5 nút, quorum là 3 nút.
 * Tầm quan trọng:
   * Quorum rất quan trọng để đảm bảo tính nhất quán và độ tin cậy của cluster.
   * Khi cluster mất quorum, nó sẽ chuyển sang chế độ chỉ đọc (read-only) hoặc ngừng hoạt động để tránh xung đột dữ liệu.
 * Qdevice:
   * Trong các cluster có số lượng node là chẵn, hoặc trong các cluster có ít node(2 node) thì việc sảy ra "split brain" rất cao. Vì vậy Qdevice được tạo ra để ngăn chặn tình trạng này. Qdevice hoạt động như 1 node thứ 3(hoặc hơn) và có thể đặt trên 1 máy ảo ở ngoài cluster.
Tóm lại:
 * Corosync là nền tảng giao tiếp cho HA trong Proxmox VE.
 * Quorum là cơ chế đảm bảo tính nhất quán và ngăn chặn "split-brain".
 * Hiểu rõ về Corosync và quorum là rất quan trọng để quản lý và vận hành cluster Proxmox VE một cách hiệu quả.


## Một vài khuyến nghị

#### 1. Mạng (Network):

Đảm bảo mạng giữa các nút có độ trễ thấp và ổn định. Điều này rất quan trọng cho hoạt động của Corosync và quorum.
Nếu có thể, hãy sử dụng mạng riêng biệt cho giao tiếp Corosync để tăng tính ổn định.
Kiểm tra kỹ lưỡng các địa chỉ IP ring1_addr để đảm bảo chúng chính xác và có thể kết nối được.

#### 2. Quorum:

Với 3 nút, cluster có thể chịu được lỗi của 1 nút. Tuy nhiên, hãy cân nhắc thêm nút nếu bạn cần khả năng chịu lỗi cao hơn.
Cần đặc biệt lưu ý khi có sự cố mạng, vì khi mạng chia cắt, sẽ có hiện tượng phân mảnh cluster (split brain).
Nếu có thể hãy triển khai một thiết bị Quorum(QDevice) cho Proxmox, điều này sẽ giúp ngăn chặn hiện tượng split brain.

#### 3. Bảo Mật:

secauth: on là một cấu hình tốt. Hãy đảm bảo rằng bạn quản lý khóa xác thực một cách an toàn.
Giám Sát (Monitoring):

Theo dõi log syslog của Corosync để phát hiện sớm các vấn đề.
Sử dụng các công cụ giám sát Proxmox để theo dõi trạng thái cluster và tài nguyên.

#### 4. Sao Lưu (Backup):

Thiết lập sao lưu thường xuyên cho các máy ảo và container trong cluster.
Kiểm tra định kì tính khả dụng của các bản sao lưu.

#### 5. Cập Nhật (Updates):

Luôn cập nhật Proxmox và các gói phần mềm liên quan để đảm bảo bảo mật và hiệu suất tốt nhất.

#### 6. Kiểm Tra và Thử Nghiệm (Testing):

Sau khi cấu hình, hãy kiểm tra kỹ lưỡng hoạt động của cluster, bao gồm khả năng chịu lỗi và hiệu suất.
Thực hiện các thử nghiệm failover để đảm bảo cluster hoạt động đúng như mong đợi.
Những lời khuyên này sẽ giúp bạn quản lý cluster Proxmox một cách hiệu quả và đảm bảo tính ổn định và bảo mật.