## Trên Linux, có 7 chế độ bonding (mode link aggregation) sau đây:

#### Mode 0 (balance-rr - Round-Robin):

    Phân phối các frame luân phiên qua các slave interface.

    Cân bằng tải tốt, nhưng không đảm bảo thứ tự các frame.

#### Mode 1 (active-backup):

    Chỉ có một slave interface hoạt động, các slave khác ở trạng thái dự phòng.

    Khi slave hoạt động bị lỗi, một slave khác sẽ được kích hoạt.

    Không cân bằng tải.

#### Mode 2 (balance-xor):

    Sử dụng một hàm băm để quyết định gửi frame qua slave nào.

    Đảm bảo thứ tự các frame, nhưng không cân bằng tải.

#### Mode 3 (broadcast):

    Gửi tất cả các frame qua tất cả các slave interface.

    Đảm bảo tính dự phòng, nhưng không cân bằng tải.

#### Mode 4 (802.3ad - Dynamic Link Aggregation):

    Sử dụng LACP (Link Aggregation Control Protocol) để tự động cấu hình các kết nối.

    Cân bằng tải tốt, đảm bảo thứ tự các frame.

#### Mode 5 (balance-tlb - Adaptive Transmit Load Balancing):

    Tự động cân bằng tải ở lớp 2 (MAC) dựa trên tải của mỗi slave.

    Không cần LACP, nhưng không đảm bảo thứ tự các frame.

#### Mode 6 (balance-alb - Adaptive Load Balancing):

    Kết hợp cả cân bằng tải ở lớp 2 (MAC) và lớp 3 (IP).

    Không cần LACP, đảm bảo tính dự phòng, nhưng không đảm bảo thứ tự các frame.

Tùy thuộc vào yêu cầu của ứng dụng và đặc điểm của mạng, bạn có thể chọn một chế độ bonding phù hợp. Các chế độ 0, 4, 5 và 6 được sử dụng phổ biến nhất.

## Thực hành testing từng mode

Thực hiện config Ether Channel trên Cisco C3750 và 2 port trên ubuntu22.04 với eno1 và eno2

    swcore1#show etherchannel summary

    Flags:  D - down        P - bundled in port-channel
            I - stand-alone s - suspended
            H - Hot-standby (LACP only)
            R - Layer3      S - Layer2
            U - in use      f - failed to allocate aggregator
    
            M - not in use, minimum links not met
            u - unsuitable for bundling
            w - waiting to be aggregated
            d - default port


    Number of channel-groups in use: 0
    Number of aggregators:           0

    Group  Port-channel  Protocol    Ports
    ------+-------------+-----------+-----------------------------------------------

#### Cấu hình switch Cisco nhóm port Gi1/0/3-4 thành Po1

    swcore1(config)#interface range Gi1/0/3-4

    swcore1(config-if-range)#no shutdown

    swcore1(config-if-range)#channel-group 1 mode active

    swcore1(config)#interface port-channel 1

    swcore1(config-if)#sw trunk encapsulation dot1q

    swcore1(config-if)#sw mode trunk

    swcore1(config-if)#end
    swcore1#wr mem
    Building configuration...
    [OK]

## Bonding 2 port trên server gom thành 1

Mình có máy chủ ubuntu 22.04, mình cài đặt các gói sau:

    apt-get install ifenslave

Tạo file config trong /etc/netplan/

    /etc/netplan/bonding-eno1-eno2.yaml

  <img src="Basicnetworkimages/82.png">

Đã ssh thành công

  <img src="Basicnetworkimages/83.png">

#### 1.mode: 802.3ad

Như bạn nhìn thấy mode trên là mode 4 (802.3ad - Dynamic Link Aggregation):Cân bằng tải tốt, đảm bảo thứ tự các frame.

    mode: 802.3ad 
    lacp-rate: fast

Chúng ta sẽ tiến hành kiểm thử,và đầu tiên chúng ta sẽ check lệnh:

    cat /proc/net/bonding/bond0

Để xem trạng thái và cấu hình của bonding interface.

    root@tudv:~# cat /proc/net/bonding/bond0
    Ethernet Channel Bonding Driver: v5.15.0-133-generic

    Bonding Mode: IEEE 802.3ad Dynamic link aggregation
    Transmit Hash Policy: layer2 (0)
    MII Status: up
    MII Polling Interval (ms): 100
    Up Delay (ms): 0
    Down Delay (ms): 0
    Peer Notification Delay (ms): 0

    802.3ad info
    LACP active: on
    LACP rate: fast
    Min links: 0
    Aggregator selection policy (ad_select): stable
    System priority: 65535
    System MAC address: 56:d0:e5:4a:6e:d0
    Active Aggregator Info:
        Aggregator ID: 1
        Number of ports: 2
        Actor Key: 9
        Partner Key: 1
        Partner Mac Address: e8:04:62:bf:9e:80

    Slave Interface: eno2
    MII Status: up
    Speed: 1000 Mbps
    Duplex: full
    Link Failure Count: 1
    Permanent HW addr: 90:b1:1c:11:d5:9f
    Slave queue ID: 0
    Aggregator ID: 1
    Actor Churn State: none
    Partner Churn State: none
    Actor Churned Count: 0
    Partner Churned Count: 0
    details actor lacp pdu:
        system priority: 65535
        system mac address: 56:d0:e5:4a:6e:d0
        port key: 9
        port priority: 255
        port number: 1
        port state: 63
    details partner lacp pdu:
        system priority: 32768
        system mac address: e8:04:62:bf:9e:80
        oper key: 1
        port priority: 32768
        port number: 261
        port state: 61

    Slave Interface: eno1
    MII Status: up
    Speed: 1000 Mbps
    Duplex: full
    Link Failure Count: 0
    Permanent HW addr: 90:b1:1c:11:d5:9d
    Slave queue ID: 0
    Aggregator ID: 1
    Actor Churn State: none
    Partner Churn State: none
    Churned Count: 0
    Partner Churned Count: 0
    details actor lacp pdu:
        system priority: 65535
        system mac address: 56:d0:e5:4a:6e:d0
        port key: 9
        port priority: 255
        port number: 2
        port state: 63
    details partner lacp pdu:
        system priority: 32768
        system mac address: e8:04:62:bf:9e:80
        oper key: 1
        port priority: 32768
        port number: 260
        port state: 61
Bạn có thể thấy sự hiện diện của cả 2 port eno1 và eno2

  <img src="Basicnetworkimages/94.png">

Trong ảnh trên mình đã shutdown port eno1 và eno2 mỗi port 1 lần.
