Dưới đây là mô hình **HA pfSense** với **pfSense Master** và **pfSense Backup**, đồng bộ qua **Switch riêng**, hỗ trợ HA cho cả **WAN** và **LAN**, dựa trên thông số IP của bạn:

---

### **Sơ Đồ Mô Hình**  
```
                            +-------------------------+
                            |        Internet          |
                            +------------+------------+
                                         |
                                         | (WAN VIP: 172.16.9.182/20)
                            +------------+------------+
                            |         Switch WAN       |
                            +------------+------------+
                                         |
                            +-------------------------+
                            |       pfSense1          |
                            | (WAN: 172.16.9.181/20)  |
                            | (LAN: 10.10.11.2/24)    |
                            | (Sync: 10.10.88.181/30)|
                            +------------+------------+
                                         |    ↑
              Sync via Switch riêng     |    | CARP/XMLRPC/pfsync
                (10.10.88.0/30)      ↓    |
                            +------------+------------+
                            |       pfSense2          |
                            | (WAN: 172.16.9.183/20)  |
                            | (LAN: 10.10.11.3/24)    |
                            | (Sync: 10.10.88.183/30)|
                            +------------+------------+
                                         |
                                         | (LAN VIP: 10.10.11.1/24)
                            +------------+------------+
                            |         Switch LAN      |
                            +------------+------------+
                                         |
                            +-------------------------+
                            |   Internal Network      |
                            | (10.10.11.0/24)        |
                            +-------------------------+
```

---

### **Giải Thích Chi Tiết**  

#### **1. Các Thành Phần Chính**  
- **pfSense1 (Master)** và **pfSense2 (Backup)**:  
  - **WAN Interface**:  
    - pfSense1: `172.16.9.181/20`  
    - pfSense2: `172.16.9.183/20`  
    - **WAN VIP (CARP)**: `172.16.9.182/20` (địa chỉ ảo dùng chung).  
  - **LAN Interface**:  
    - pfSense1: `10.10.11.2/24`  
    - pfSense2: `10.10.11.3/24`  
    - **LAN VIP (CARP)**: `10.10.11.1/24` (gateway cho mạng nội bộ).  
  - **Sync Interface**:  
    - Kết nối qua **Switch riêng** với subnet `10.10.88.0/30`.  
    - pfSense1: `10.10.88.181/30`  
    - pfSense2: `10.10.88.183/30`  

- **Giao Thức**:  
  - **CARP**: Quản lý VIP cho WAN và LAN.  
  - **XMLRPC**: Đồng bộ cấu hình (firewall rules, NAT).  
  - **pfsync**: Đồng bộ trạng thái kết nối (state table) qua Sync Interface.  

#### **2. Cấu Hình CARP**  
- **Trên pfSense1 (Master)**:  
  - **WAN VIP**:  
    - Virtual IP: `172.16.9.182/20`  
    - CARP Password: `<shared-secret>`  
    - CARP Priority: `255` (cao nhất).  
  - **LAN VIP**:  
    - Virtual IP: `10.10.11.1/24`  
    - CARP Password: `<shared-secret>`  
    - CARP Priority: `255`.  

- **Trên pfSense2 (Backup)**:  
  - Cấu hình tương tự, nhưng **CARP Priority** đặt `254` (thấp hơn Master).  

#### **3. Đồng Bộ Cấu Hình (XMLRPC)**  
- **Trên pfSense1 (Master)**:  
  - Vào **System > High Availability > Settings**:  
    - Enable **XMLRPC Sync**.  
    - Thêm IP của pfSense2 (`10.10.88.183`) vào mục **Synchronize to IP**.  
    - Nhập **Shared Secret** và chọn các cấu hình cần đồng bộ (Rules, NAT, VPN, v.v.).  

- **Trên pfSense2 (Backup)**:  
  - Cấu hình tương tự, đồng bộ về IP của pfSense1 (`10.10.88.181`).  

#### **4. Đồng Bộ Trạng Thái (pfsync)**  
- **Trên cả hai node**:  
  - Vào **System > High Availability > pfsync**:  
    - **Synchronize Interface**: Chọn Sync Interface (ví dụ: `opt1`).  
    - **Peer IP**: Nhập IP của node đối tác (`10.10.88.183` trên pfSense1, `10.10.88.181` trên pfSense2).  
    - **Sync Frequency**: Đặt `1` giây để đồng bộ nhanh.  

#### **5. Firewall Rules**  
- **Trên Sync Interface**:  
  - Cho phép traffic CARP (proto 112) và pfsync (proto PFSYNC).  
  - Ví dụ rule:  
    ```
    Protocol: CARP (112)  
    Source: Any  
    Destination: Any  
    Action: Allow  
    ```  

- **Trên WAN/LAN**:  
  - Đảm bảo CARP traffic được phép (nếu cần).  

---

### **Kiểm Tra Hoạt Động**  
1. **Kiểm tra Virtual IP**:  
   - Trên giao diện web pfSense, vào **Status > CARP**, xác nhận cả WAN VIP và LAN VIP đều ở trạng thái **MASTER** trên pfSense1.  

2. **Test Failover**:  
   - Tắt pfSense1, kiểm tra xem pfSense2 có tiếp quản VIP và traffic LAN/WAN không gián đoạn không.  

3. **Kiểm tra đồng bộ**:  
   - Thêm một rule firewall trên pfSense1, xác nhận rule này xuất hiện trên pfSense2 sau vài giây.  

---

### **Lưu Ý Quan Trọng**  
- Đảm bảo **Switch riêng** cho Sync Interface không bị nghẽn hoặc lỗi.  
- **WAN VIP** (`172.16.9.182/20`) phải được định tuyến đúng từ Internet.  
- Nếu sử dụng PPPoE, cần cấu hình thêm để CARP hoạt động.  