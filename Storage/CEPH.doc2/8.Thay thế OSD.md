Khi má»™t OSD bá»‹ down, Ceph sáº½ khÃ´ng ngay láº­p tá»©c thá»±c hiá»‡n rebalance (tÃ¡i phÃ¢n phá»‘i dá»¯ liá»‡u) mÃ  sáº½ chá» má»™t khoáº£ng thá»i gian Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem OSD Ä‘Ã³ cÃ³ thá»±c sá»± máº¥t hay khÃ´ng.

CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»¥ thá»ƒ nhÆ° sau:

#### OSD bá»‹ down

Khi má»™t OSD máº¥t káº¿t ná»‘i hoáº·c ngá»«ng hoáº¡t Ä‘á»™ng, Ceph sáº½ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  down vÃ  out sau má»™t khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh náº¿u nÃ³ khÃ´ng tá»± khÃ´i phá»¥c.

Tráº¡ng thÃ¡i nÃ y sáº½ Ä‘Æ°á»£c pháº£n Ã¡nh trong ceph health detail vÃ  cÃ¡c PG sá»­ dá»¥ng OSD Ä‘Ã³ cÃ³ thá»ƒ chuyá»ƒn sang tráº¡ng thÃ¡i undersized, degraded.

Chá» thá»i gian Ä‘á»ƒ xÃ¡c nháº­n máº¥t dá»¯ liá»‡u

Ceph cÃ³ tham sá»‘ mon_osd_report_timeout (máº·c Ä‘á»‹nh 900 giÃ¢y = 15 phÃºt), trong thá»i gian nÃ y náº¿u OSD hoáº¡t Ä‘á»™ng trá»Ÿ láº¡i thÃ¬ há»‡ thá»‘ng khÃ´ng thá»±c hiá»‡n rebalance.

Náº¿u OSD khÃ´ng quay láº¡i, Ceph thá»±c hiá»‡n backfill & recovery

Náº¿u sau mon_osd_report_timeout, OSD váº«n khÃ´ng quay láº¡i, Ceph sáº½ báº¯t Ä‘áº§u sao chÃ©p láº¡i dá»¯ liá»‡u bá»‹ thiáº¿u tá»« cÃ¡c OSD cÃ²n sá»‘ng sang cÃ¡c OSD khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o má»©c replica Ä‘Æ°á»£c duy trÃ¬.

QuÃ¡ trÃ¬nh nÃ y gá»i lÃ  backfill & recovery, lÃ m tÄƒng táº£i IO trÃªn cluster.

#### Khi OSD bá»‹ máº¥t hoÃ n toÃ n (out)

Náº¿u OSD máº¥t hoÃ n toÃ n vÃ  admin chá»§ Ä‘á»™ng remove OSD khá»i cluster báº±ng lá»‡nh: ``ceph osd out <osd_id> `` `` ceph osd crush remove osd.<osd_id> `` â†’ LÃºc nÃ y Ceph sáº½ rebalance láº¡i dá»¯ liá»‡u ngay láº­p tá»©c Ä‘á»ƒ Ä‘áº£m báº£o sá»‘ lÆ°á»£ng báº£n sao Ä‘Ãºng theo replication size.

    ceph config get mon mon_osd_report_timeout

  <img src="cephimages/Screenshot_54.png">

  <img src="cephimages/Screenshot_55.png">


CÃ¢u há»i Ä‘áº·t ra lÃ  há»‡ thá»‘ng cÃ³ tá»± remove OSD ra khá»i Cluster khi vÆ°á»£t quÃ¡ thá»i gian cá»§a mon_osd_report_timeout hay khÃ´ng?

Khi má»™t OSD bá»‹ down vÃ  vÆ°á»£t quÃ¡ thá»i gian mon_osd_report_timeout, nÃ³ khÃ´ng tá»± Ä‘á»™ng bá»‹ remove khá»i cluster mÃ  sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  out sau má»™t thá»i gian nháº¥t Ä‘á»‹nh. Cá»¥ thá»ƒ:

ğŸ”¹ CÃ¡ch Ceph xá»­ lÃ½ OSD down lÃ¢u

#### OSD bá»‹ down

Khi OSD máº¥t káº¿t ná»‘i, Ceph sáº½ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  down.

  + Há»‡ thá»‘ng váº«n giá»¯ metadata cá»§a OSD Ä‘Ã³, khÃ´ng loáº¡i bá» ngay.
  + Sau mon_osd_report_timeout (máº·c Ä‘á»‹nh: 900 giÃ¢y = 15 phÃºt)
  + Monitor sáº½ coi OSD lÃ  khÃ´ng pháº£n há»“i trong thá»i gian dÃ i.
  + CÃ¡c PG chá»©a OSD nÃ y cÃ³ thá»ƒ rÆ¡i vÃ o tráº¡ng thÃ¡i undersized, degraded, hoáº·c inconsistent.
  + Sau osd_out_timeout (máº·c Ä‘á»‹nh: 600 giÃ¢y = 10 phÃºt)
  + Náº¿u OSD váº«n chÆ°a quay láº¡i, nÃ³ sáº½ bá»‹ Ä‘Ã¡nh dáº¥u lÃ  â€œoutâ€.
  + Há»‡ thá»‘ng báº¯t Ä‘áº§u rebalance dá»¯ liá»‡u sang cÃ¡c OSD khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»§ sá»‘ báº£n sao (replicas).

OSD váº«n khÃ´ng quay láº¡i?

  + NÃ³ váº«n tá»“n táº¡i trong cluster, nhÆ°ng sáº½ khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u.
  + Náº¿u muá»‘n loáº¡i bá» háº³n, báº¡n pháº£i xÃ³a thá»§ cÃ´ng báº±ng: ceph osd purge <osd_id> --yes-i-really-mean-it

KÃªt luáº­n

  + mon_osd_report_timeout khÃ´ng tá»± Ä‘á»™ng xÃ³a OSD, chá»‰ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  down.
  + osd_out_timeout sáº½ Ä‘Ã¡nh dáº¥u nÃ³ lÃ  out náº¿u máº¥t káº¿t ná»‘i quÃ¡ lÃ¢u.
  + Ceph sáº½ tá»± Ä‘á»™ng rebalance dá»¯ liá»‡u náº¿u má»™t OSD bá»‹ out.
  + Náº¿u OSD bá»‹ há»ng hoÃ n toÃ n, báº¡n pháº£i xÃ³a thá»§ cÃ´ng.

#### Xá»­ lÃ½ thay tháº¿ osd.0 trÃªn 1 mÃ¡y chá»§

  <img src="cephimages/Screenshot_56.png">

  <img src="cephimages/Screenshot_57.png">

  <img src="cephimages/Screenshot_58.png">

```Bash
root@proxmox131:/etc/ceph# ceph osd out osd.0
marked out osd.0.
root@proxmox131:/etc/ceph# ceph osd crush remove osd.0
removed item id 0 name 'osd.0' from crush map
root@proxmox131:/etc/ceph# ceph osd rm osd.0
removed osd.0
root@proxmox131:/etc/ceph# ceph auth del osd.0

```
  <img src="cephimages/Screenshot_59.png">

Create OSD má»›i

  <img src="cephimages/Screenshot_60.png">

  <img src="cephimages/Screenshot_61.png">

OSD 6 lÃ  OSD má»›i cáº¯m vÃ o Ä‘á»ƒ thay tháº¿

  <img src="cephimages/Screenshot_62.png">

  <img src="cephimages/Screenshot_63.png">

  <img src="cephimages/Screenshot_64.png">

#### TÃ³m táº¯t láº¡i:
```Bash
# ÄÃ¡nh dáº¥u OSD 0 lÃ  out
ceph osd out osd.0

# XÃ³a OSD 0 khá»i CRUSH map
ceph osd crush rm osd.0

# XÃ³a OSD 0 khá»i cá»¥m Ceph
ceph osd rm osd.0

# XÃ³a khÃ³a xÃ¡c thá»±c cá»§a OSD 0
ceph auth del osd.0

# (TÃ¹y chá»n) XÃ³a dá»¯ liá»‡u cá»§a OSD 0
ceph-volume lvm zap /dev/sdb # Thay /dev/sdb báº±ng Ä‘Æ°á»ng dáº«n thiáº¿t bá»‹ thá»±c táº¿

# Kiá»ƒm tra tráº¡ng thÃ¡i cá»¥m
ceph -s

```
Äá»£i 1 chÃºt thá»i gian lÃ  node sáº½ há»“i phá»¥c vÃ  chÃºng ta cáº§n cáº­p nháº­t láº¡i PG Ä‘á»“ng Ä‘á»u

  <img src="cephimages/Screenshot_65.png">

  <img src="cephimages/Screenshot_66.png">

  <img src="cephimages/Screenshot_67.png">

Sau Ä‘Ã³ mÃ¬nh gá»¡ thÃªm 2 á»• vÃ  destroy

  <img src="cephimages/Screenshot_68.png">

PG Ä‘Ã£ phÃ¢n phá»‘i láº¡i láº§n ná»¯a








